"use client"

import React, { useState, useEffect } from 'react'
import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import { ChatAssistant } from '@/components/chat/chat-assistant'
import { Sidebar } from '../Sidebar/Sidebar'
import { Breadcrumbs } from '../Breadcrumbs/Breadcrumbs'
import { UserMenu } from '../user-menu'
import {\n  Menu,\n  Search,\n  Bell,\n  MessageCircle,\n  Command,\n  Zap,\n  ChevronDown\n} from 'lucide-react'\nimport { useHotkeys } from 'react-hotkeys-hook'\n\ninterface MainLayoutProps {\n  children: React.ReactNode\n  showChatAssistant?: boolean\n  showBreadcrumbs?: boolean\n  sidebarCollapsed?: boolean\n  onSidebarCollapsedChange?: (collapsed: boolean) => void\n  className?: string\n}\n\nexport function MainLayout({\n  children,\n  showChatAssistant = true,\n  showBreadcrumbs = true,\n  sidebarCollapsed: controlledCollapsed,\n  onSidebarCollapsedChange,\n  className\n}: MainLayoutProps) {\n  const [isChatOpen, setIsChatOpen] = useState(false)\n  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)\n  const [searchQuery, setSearchQuery] = useState('')\n  const [showCommandPalette, setShowCommandPalette] = useState(false)\n  const [internalCollapsed, setInternalCollapsed] = useState(false)\n  \n  // Use controlled or internal state for sidebar collapse\n  const isCollapsed = controlledCollapsed !== undefined ? controlledCollapsed : internalCollapsed\n  const handleCollapsedChange = (collapsed: boolean) => {\n    if (onSidebarCollapsedChange) {\n      onSidebarCollapsedChange(collapsed)\n    } else {\n      setInternalCollapsed(collapsed)\n    }\n  }\n\n  // Keyboard shortcuts\n  useHotkeys('cmd+k, ctrl+k', (e) => {\n    e.preventDefault()\n    setShowCommandPalette(true)\n  })\n\n  useHotkeys('cmd+/', (e) => {\n    e.preventDefault()\n    setIsChatOpen(true)\n  })\n\n  useHotkeys('cmd+b', (e) => {\n    e.preventDefault()\n    handleCollapsedChange(!isCollapsed)\n  })\n\n  // Auto-collapse on mobile\n  useEffect(() => {\n    const handleResize = () => {\n      if (window.innerWidth < 1024) {\n        setInternalCollapsed(true)\n      }\n    }\n    \n    handleResize()\n    window.addEventListener('resize', handleResize)\n    return () => window.removeEventListener('resize', handleResize)\n  }, [])\n\n  return (\n    <div className={cn('min-h-screen bg-background flex', className)}>\n      {/* Desktop Sidebar */}\n      <div className=\"hidden lg:flex\">\n        <Sidebar\n          isCollapsed={isCollapsed}\n          onCollapsedChange={handleCollapsedChange}\n        />\n      </div>\n\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col min-w-0\">\n        {/* Header */}\n        <header className=\"sticky top-0 z-40 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n          <div className=\"flex h-header items-center px-6\">\n            {/* Mobile menu trigger */}\n            <Sheet open={isMobileMenuOpen} onOpenChange={setIsMobileMenuOpen}>\n              <SheetTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" className=\"lg:hidden\">\n                  <Menu className=\"h-5 w-5\" />\n                </Button>\n              </SheetTrigger>\n              <SheetContent side=\"left\" className=\"w-72 p-0\">\n                <Sidebar isCollapsed={false} />\n              </SheetContent>\n            </Sheet>\n\n            {/* Mobile logo (only show when sidebar is hidden) */}\n            <div className=\"flex items-center gap-3 lg:hidden\">\n              <div className=\"h-8 w-8 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center\">\n                <span className=\"text-white font-bold text-sm\">H₂O</span>\n              </div>\n              <div>\n                <h1 className=\"font-semibold text-sm\">H₂O Allegiant</h1>\n              </div>\n            </div>\n\n            {/* Search Bar */}\n            <div className=\"flex-1 max-w-md mx-6\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Buscar proyectos, propuestas... (⌘K)\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  onFocus={() => setShowCommandPalette(true)}\n                  className=\"pl-10 pr-12\"\n                />\n                <div className=\"absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1\">\n                  <kbd className=\"hidden sm:inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100\">\n                    <Command className=\"h-3 w-3\" />\n                    <span>K</span>\n                  </kbd>\n                </div>\n              </div>\n            </div>\n\n            {/* Header Actions */}\n            <div className=\"flex items-center gap-2\">\n              {/* Quick Actions */}\n              <Button variant=\"ghost\" size=\"icon\" className=\"relative\">\n                <Zap className=\"h-4 w-4\" />\n              </Button>\n\n              {/* Notifications */}\n              <Button variant=\"ghost\" size=\"icon\" className=\"relative\">\n                <Bell className=\"h-4 w-4\" />\n                <Badge\n                  variant=\"destructive\"\n                  className=\"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs\"\n                >\n                  3\n                </Badge>\n              </Button>\n\n              {/* Chat Assistant Toggle */}\n              {showChatAssistant && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setIsChatOpen(true)}\n                  className=\"relative\"\n                >\n                  <MessageCircle className=\"h-4 w-4\" />\n                  <div className=\"absolute -top-1 -right-1 h-2 w-2 bg-green-500 rounded-full animate-pulse\" />\n                </Button>\n              )}\n\n              <Separator orientation=\"vertical\" className=\"h-6\" />\n\n              {/* User Menu */}\n              <UserMenu />\n            </div>\n          </div>\n\n          {/* Breadcrumbs */}\n          {showBreadcrumbs && (\n            <div className=\"border-t bg-muted/30\">\n              <div className=\"px-6 py-3\">\n                <Breadcrumbs />\n              </div>\n            </div>\n          )}\n        </header>\n\n        {/* Main Content */}\n        <main className=\"flex-1 overflow-hidden\">\n          <div className=\"h-full\">\n            {children}\n          </div>\n        </main>\n      </div>\n\n      {/* Chat Assistant */}\n      {showChatAssistant && (\n        <Sheet open={isChatOpen} onOpenChange={setIsChatOpen}>\n          <SheetContent side=\"right\" className=\"w-96 p-0\">\n            <div className=\"h-full flex flex-col\">\n              <div className=\"p-4 border-b\">\n                <h3 className=\"font-semibold\">Asistente Técnico</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  AI especializado en tratamiento de agua\n                </p>\n              </div>\n              <div className=\"flex-1\">\n                <ChatAssistant onClose={() => setIsChatOpen(false)} />\n              </div>\n            </div>\n          </SheetContent>\n        </Sheet>\n      )}\n\n      {/* Command Palette (placeholder for future implementation) */}\n      {showCommandPalette && (\n        <div\n          className=\"fixed inset-0 z-50 bg-background/80 backdrop-blur-sm\"\n          onClick={() => setShowCommandPalette(false)}\n        >\n          <div className=\"fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2\">\n            <div className=\"w-[640px] max-w-[90vw] bg-background border rounded-lg shadow-lg p-4\">\n              <p className=\"text-center text-muted-foreground\">\n                Command Palette - Próximamente\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}"